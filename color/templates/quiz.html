{% extends "layout.html" %}
{% block content %}

<!-- Load iro.js color wheel -->
<script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>

<div class="quiz-screen d-flex flex-column justify-content-center align-items-center">

  {% if qnum == 0 %}
    <h1 class="mb-4">Ready to take the quiz?</h1>
    <a href="/quiz/1" class="btn btn-primary btn-lg">Start Quiz</a>

  {% elif question %}
    <h2 class="mb-4">Question {{ qnum }}:<br>{{ question.question }}</h2>

    {% if question.image %}
      <img src="{{ question.image }}" class="mb-4 img-fluid" alt="Question Image" style="max-width: 500px;">
    {% endif %}

    {% if question.image_options %}
      <div class="q-grid {% if qnum == 3 %}q3-grid{% endif %}">
        {% for img_url in question.image_options %}
          <div class="text-center">
            <div class="label-box">{{ 'ABCDEF'[loop.index0] }}</div>
            <img src="{{ img_url }}" class="q-option {% if qnum == 3 %}q3-option{% endif %} img-thumbnail m-2" data-option="{{ 'ABCDEF'[loop.index0] }}" alt="Option {{ 'ABCDEF'[loop.index0] }}" style="cursor:pointer; max-width: 200px;">
            
          </div>
        {% endfor %}
      </div>
    {% elif question.options %}
      <div class="q-grid">
        {% for option in question.options %}
          <div class="text-center">
            <div class="label-box">{{ 'ABCD'[loop.index0] }}</div>
            <div class="q-option btn btn-light m-2" data-option="{{ 'ABCD'[loop.index0] }}">{{ option }}</div>
          </div>
        {% endfor %}
      </div>
    {% elif question.type == 'drag' and question.correct_index is defined %}
      <div class="drag-q67-layout d-flex justify-content-between w-100">
        <div class="left-col d-grid drag-grid">
          {% for color in question.choices %}
            <div class="color-block uniform-block" style="background-color: {{ color }};" data-color="{{ color }}" draggable="true"></div>
          {% endfor %}
        </div>

        <div class="right-col d-flex flex-column align-items-center">
          <div class="color-wheel mb-3" id="colorWheel" style="width: 240px;"></div>
          <div class="text-muted mb-2">Drag and drop here</div>
          <div class="d-flex justify-content-center align-items-center gap-3">
            {% if qnum == 6 %}
              <div class="color-swatch uniform-block" style="background-color: #f88;"></div>
              <div class="drop-zone uniform-block" data-correct-index="{{ question.correct_index + 1 }}"></div>
              <div class="color-swatch uniform-block" style="background-color: #660000;"></div>
            {% elif qnum == 7 %}
              <div class="color-swatch uniform-block" style="background-color: yellow;"></div>
              <div class="drop-zone uniform-block" data-correct-index="{{ question.correct_index + 1 }}"></div>
              <div class="color-swatch uniform-block" style="background-color: blue;"></div>
            {% endif %}
          </div>
          {% if question.hint %}<div id="hint-text" class="alert alert-info mt-3" style="display:none;">Hint: {{ question.hint }}</div>{% endif %}
          <div id="drop-feedback" class="font-weight-bold mt-2"></div>
        </div>
      </div>
    {% elif question.type == 'drag' and question.drop_slots is defined %}
      <div class="drag-q8 w-100 d-flex flex-column align-items-center">
        <div class="d-flex flex-wrap justify-content-center mb-4">
          {% for color in question.choices %}
            <div class="color-block uniform-block" style="background-color: {{ color }};" data-color="{{ color }}" draggable="true"></div>
          {% endfor %}
        </div>
        <div class="d-flex justify-content-center flex-wrap">
          {% for i in range(question.drop_slots) %}
            <div class="drop-zone q8-drop uniform-block" data-slot="{{ i }}"></div>
          {% endfor %}
        </div>
        <div id="q8-feedback" class="mt-3 font-weight-bold text-success" style="font-size: 1.2rem;"></div>
      </div>
    {% endif %}

    <div id="feedback" class="mt-4 font-weight-bold"></div>
    {% if question.hint and question.type != 'drag' %}
      <div id="hint" class="text-muted mt-2" style="display: none;">Hint: {{ question.hint }}</div>
    {% endif %}

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const colorWheel = new iro.ColorPicker("#colorWheel", {
          width: 220,
          color: "#f00",
          layout: [
            { component: iro.ui.Wheel },
            { component: iro.ui.Slider, options: { sliderType: 'value' } }
          ]
        });
      });
    </script>

  {% else %}
    <h2>Thanks for completing the quiz!</h2>
    <a href="/result" class="btn btn-success mt-4">View Your Score</a>
  {% endif %}
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
<script src="../static/drag_logic.js"></script>

<style>
.quiz-screen {
  min-height: 90vh;
  text-align: center;
}
.q-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 30px;
  max-width: 800px;
  margin: 0 auto;
  justify-items: center;
}
.q-option {
  background-color: #f8f9fa;
  border: 2px solid #ddd;
  padding: 12px 20px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
  width: 100%;
  min-height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.q-option:hover {
  background-color: #e2e6ea;
  border-color: #007bff;
  transform: translateY(-2px);
}
.label-box {
  width: 30px;
  height: 30px;
  background-color: black;
  color: white;
  font-weight: bold;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 5px;
  border-radius: 5px;
}
.color-block,
.drop-zone,
.q8-drop,
.color-swatch {
  width: 80px;
  height: 80px;
  border-radius: 10px;
  border: 2px solid #555;
  margin: 10px;
  cursor: grab;
}
.drag-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}
.drag-q67-layout {
  display: flex;
  width: 100%;
  justify-content: space-between;
  gap: 40px;
  align-items: start;
}
.color-wheel {
  margin-bottom: 10px;
}
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const options = document.querySelectorAll(".q-option");
    const feedback = document.getElementById("feedback");
    const hint = document.getElementById("hint");
    let attempts = 0;

    options.forEach(option => {
      option.addEventListener("click", function () {
        const selected = this.dataset.option;
        const qnum = parseInt(window.location.pathname.split("/quiz/")[1]);

        fetch("/submit_answer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ qnum: qnum, answer: selected })
        })
        .then(res => res.json())
        .then(data => {
          if (data.correct) {
            feedback.textContent = "Correct!";
            feedback.style.color = "green";
            setTimeout(() => window.location.href = `/quiz/${qnum + 1}`, 1200);
          } else {
            attempts++;
            feedback.textContent = attempts === 1
              ? "Oops! One more try!"
              : "Sorry, moving to the next question.";
            feedback.style.color = attempts === 1 ? "red" : "gray";
            if (attempts === 1 && hint) hint.style.display = "block";
            if (attempts > 1) {
              setTimeout(() => window.location.href = `/quiz/${qnum + 1}`, 1500);
            }
          }
        })
        .catch(err => console.error("Submission error:", err));
      });
    });
  });
</script>


{% endblock %}
